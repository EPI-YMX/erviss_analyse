---
title: "Getting Started with ervissanalyse"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with ervissanalyse}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 6
)
```

## Introduction

The `ervissanalyse` package makes it easy to retrieve ERVISS (European Respiratory
Virus Surveillance Summary) data from the EU-ECDC. It provides functions to fetch
and filter data, plus optional visualization tools.

```{r setup}
library(ervissanalyse)
```

## Retrieving Positivity Data

### Basic usage

Use `get_erviss_positivity()` to fetch positivity data:

```{r get-positivity, eval=FALSE}
# Get SARS-CoV-2 positivity data for specific countries
data <- get_erviss_positivity(
  date_min = as.Date("2024-01-01"),
  date_max = as.Date("2024-12-31"),
  pathogen = "SARS-CoV-2",
  countries = c("France", "Germany", "Italy", "Spain")
)

# Explore the data
head(data)
str(data)
```

### Using a historical snapshot

For reproducible analyses, you can fetch data from a specific snapshot:

```{r get-positivity-snapshot, eval=FALSE}
data <- get_erviss_positivity(
  date_min = as.Date("2023-01-01"),
  date_max = as.Date("2023-12-31"),
  pathogen = "Influenza",
  use_snapshot = TRUE,
  snapshot_date = as.Date("2024-02-23")
)
```

## Retrieving Variant Data

### Basic usage

Use `get_erviss_variants()` to fetch SARS-CoV-2 variant data:

```{r get-variants, eval=FALSE}
# Get specific variants
data <- get_erviss_variants(
  date_min = as.Date("2024-06-01"),
  date_max = as.Date("2024-12-31"),
  variant = c("XFG", "LP.8.1", "BA.2.86"),
  countries = c("Belgium", "Denmark", "France")
)

# Get all variants with minimum proportion threshold
data <- get_erviss_variants(
  date_min = as.Date("2024-01-01"),
  date_max = as.Date("2024-12-31"),
  min_value = 5 # Only variants with >= 5% proportion
)
```

## Analyzing the Data

Once you have retrieved the data, you can analyze it with your preferred tools:

```{r analyze-data, eval=FALSE}
library(dplyr)

# Get positivity data
data <- get_erviss_positivity(
  date_min = as.Date("2024-01-01"),
  date_max = as.Date("2024-06-30"),
  pathogen = "SARS-CoV-2"
)

# Calculate summary statistics by country
data %>%
  group_by(countryname) %>%
  summarise(
    mean_positivity = mean(value, na.rm = TRUE),
    max_positivity = max(value, na.rm = TRUE),
    n_weeks = n()
  )
```

## Visualization (Optional)

The package provides optional visualization functions for quick exploration.

### Using plot functions

```{r plot-data, eval=FALSE}
# Get data first
data <- get_erviss_positivity(
  date_min = as.Date("2024-01-01"),
  date_max = as.Date("2024-06-30"),
  pathogen = "SARS-CoV-2",
  countries = c("France", "Germany")
)

# Then plot
plot_erviss_positivity(data, date_breaks = "1 month")
```

### Quick plotting

For a quick visualization without saving the data:

```{r quick-plot, eval=FALSE}
quick_plot_erviss_positivity(
  date_min = as.Date("2024-01-01"),
  date_max = as.Date("2024-12-31"),
  pathogen = "SARS-CoV-2",
  countries = c("France", "Germany", "Italy"),
  date_breaks = "1 month",
  date_format = "%b %Y"
)

quick_plot_erviss_variants(
  date_min = as.Date("2025-06-01"),
  date_max = as.Date("2025-12-31"),
  variant = c("XFG", "LP.8.1"),
  date_breaks = "1 month",
  countries = c("Belgium", "Denmark", "France")
)
```

### Custom ggplot2 visualizations

You can also create your own visualizations:

```{r custom-plot, eval=FALSE}
library(ggplot2)

data <- get_erviss_positivity(
  date_min = as.Date("2024-01-01"),
  date_max = as.Date("2024-06-30"),
  pathogen = "SARS-CoV-2"
)

ggplot(data, aes(x = date, y = value, color = countryname)) +
  geom_line(linewidth = 1) +
  labs(
    title = "SARS-CoV-2 Positivity Rates",
    x = "Date",
    y = "Positivity (%)",
    color = "Country"
  ) +
  theme_minimal()
```

## URL Helpers

You can retrieve the data URLs directly if you prefer to download files manually:

```{r urls}
# Latest data URLs
get_erviss_positivity_url()
get_erviss_variants_url()

# Snapshot URLs
get_erviss_positivity_url(
  use_snapshot = TRUE,
  snapshot_date = as.Date("2023-11-24")
)
get_erviss_variants_url(
  use_snapshot = TRUE,
  snapshot_date = as.Date("2023-11-24")
)
```

## Complete Example

Here's a complete workflow for analyzing variant data:

```{r complete-example, eval=FALSE}
library(ervissanalyse)
library(dplyr)

# 1. Define parameters
countries <- c("France", "Germany", "Italy", "Spain", "Belgium")
start_date <- as.Date("2024-06-01")
end_date <- as.Date("2024-12-31")

# 2. Retrieve data
variant_data <- get_erviss_variants(
  date_min = start_date,
  date_max = end_date,
  countries = countries,
  min_value = 1
)

# 3. Explore the data
cat("Number of observations:", nrow(variant_data), "\n")
cat("Countries:", unique(variant_data$countryname), "\n")
cat("Variants:", unique(variant_data$variant), "\n")

# 4. Find the dominant variants
dominant <- variant_data %>%
  group_by(variant) %>%
  summarise(mean_proportion = mean(value)) %>%
  arrange(desc(mean_proportion)) %>%
  head(5)

print(dominant)

# 5. Visualize top variants
top_variants <- dominant$variant

quick_plot_erviss_variants(
  date_min = start_date,
  date_max = end_date,
  variant = top_variants,
  countries = countries,
  date_breaks = "1 month",
  min_value = 1
)
```

## Session Info

```{r session-info}
sessionInfo()
```
